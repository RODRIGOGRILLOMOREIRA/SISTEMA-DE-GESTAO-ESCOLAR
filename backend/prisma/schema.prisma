generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model alunos {
  id               String           @id
  nome             String
  cpf              String           @unique
  dataNascimento   DateTime
  email            String           @unique
  telefone         String?
  endereco         String?
  responsavel      String
  telefoneResp     String
  turmaId          String?
  numeroMatricula  String?
  statusMatricula  String?          @default("ATIVO")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  turmas           turmas?          @relation(fields: [turmaId], references: [id])
  frequencias      frequencias[]
  matriculas       matriculas[]
  notas            notas[]
  presenca_aluno   PresencaAluno[]
  notas_finais     notas_finais[]   @relation("NotasFinaisToAluno")
}

model calendario_escolar {
  id                 String               @id
  ano                Int                  @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  eventos_calendario eventos_calendario[]
}

model configuracoes {
  id          String   @id
  nomeEscola  String
  redeEscolar String?
  endereco    String
  telefone    String?
  email       String?
  logoUrl     String?
  temaModo    String   @default("light")
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model disciplinas {
  id                  String                @id
  nome                String
  cargaHoraria        Int
  professorId         String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  professores         professores?          @relation(fields: [professorId], references: [id])
  disciplinas_turmas  disciplinas_turmas[]
  horarios_aula       horarios_aula[]
  notas               notas[]
  registro_frequencia registro_frequencia[]
  turmas              turmas[]              @relation("DisciplinaToTurma")
  notas_finais        notas_finais[]        @relation("NotasFinaisToDisciplina")
}

model disciplinas_turmas {
  id           String       @id
  disciplinaId String
  turmaId      String
  professorId  String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  disciplinas  disciplinas  @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  professores  professores? @relation(fields: [professorId], references: [id])
  turmas       turmas       @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([disciplinaId, turmaId])
}

model equipe_diretiva {
  id                     String                   @id
  nome                   String
  cpf                    String
  email                  String
  telefone               String?
  cargo                  String
  cargaHorariaSemanal    Int?                     @default(40)
  horarioEntradaPadrao   String?
  horarioSaidaPadrao     String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
}

model eventos_calendario {
  id                 String             @id
  calendarioId       String
  tipo               TipoEvento
  descricao          String?
  dataInicio         DateTime
  dataFim            DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  calendario_escolar calendario_escolar @relation(fields: [calendarioId], references: [id], onDelete: Cascade)
}

model frequencias {
  id         String   @id
  alunoId    String
  turmaId    String
  data       DateTime
  presente   Boolean  @default(true)
  observacao String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  alunos     alunos   @relation(fields: [alunoId], references: [id])
  turmas     turmas   @relation(fields: [turmaId], references: [id])
}

model funcionarios {
  id                     String                   @id
  nome                   String
  cpf                    String
  email                  String
  telefone               String?
  cargo                  String
  setor                  String?
  cargaHorariaSemanal    Int?                     @default(40)
  horarioEntradaPadrao   String?
  horarioSaidaPadrao     String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
}

model grade_horaria {
  id            String          @id
  turmaId       String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  turmas        turmas          @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  horarios_aula horarios_aula[]
}

model horarios_aula {
  id                  String                @id
  gradeId             String
  diaSemana           DiaSemana
  periodo             String
  ordem               Int
  horaInicio          String
  horaFim             String
  disciplinaId        String?
  professorId         String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  disciplinas         disciplinas?          @relation(fields: [disciplinaId], references: [id])
  grade_horaria       grade_horaria         @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  professores         professores?          @relation(fields: [professorId], references: [id])
  registro_frequencia registro_frequencia[]
}

model matriculas {
  id            String   @id
  alunoId       String
  turmaId       String
  dataMatricula DateTime @default(now())
  status        String   @default("ATIVA")
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  alunos        alunos   @relation(fields: [alunoId], references: [id])
  turmas        turmas   @relation(fields: [turmaId], references: [id])
}

model notas {
  id                 String      @id
  alunoId            String
  disciplinaId       String
  trimestre          Int
  anoLetivo          Int         @default(2025)
  avaliacao01        Float?
  avaliacao02        Float?
  avaliacao03        Float?
  mediaM1            Float?
  avaliacaoEAC       Float?
  observacao         String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime
  notaFinalTrimestre Float?
  alunos             alunos      @relation(fields: [alunoId], references: [id])
  disciplinas        disciplinas @relation(fields: [disciplinaId], references: [id])

  @@unique([alunoId, disciplinaId, trimestre, anoLetivo])
}

model notas_finais {
  id           String      @id
  alunoId      String
  disciplinaId String
  anoLetivo    Int         @default(2025)
  mediaFinal   Float?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  aprovado     Boolean     @default(false)
  trimestre1   Float?
  trimestre2   Float?
  trimestre3   Float?
  aluno        alunos      @relation("NotasFinaisToAluno", fields: [alunoId], references: [id])
  disciplina   disciplinas @relation("NotasFinaisToDisciplina", fields: [disciplinaId], references: [id])

  @@unique([alunoId, disciplinaId, anoLetivo])
}

model PresencaAluno {
  id                  String              @id @default(uuid())
  registroId          String
  alunoId             String
  presente            Boolean             @default(true)
  justificativa       String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  aulaIndex           Int                 @default(0)
  alunos              alunos              @relation(fields: [alunoId], references: [id])
  registro_frequencia registro_frequencia @relation(fields: [registroId], references: [id], onDelete: Cascade)

  @@unique([registroId, alunoId, aulaIndex])
  @@map("presenca_aluno")
}

model professores {
  id                     String                   @id
  nome                   String
  cpf                    String
  email                  String
  telefone               String
  especialidade          String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  area                   String?
  componentes            String?
  turmasVinculadas       String?
  cargaHorariaSemanal    Int?                     @default(40)
  horarioEntradaPadrao   String?
  horarioSaidaPadrao     String?
  disciplinas            disciplinas[]
  disciplinas_turmas     disciplinas_turmas[]
  horarios_aula          horarios_aula[]
  registro_frequencia    registro_frequencia[]
  turmas                 turmas[]
}

model registro_frequencia {
  id             String           @id
  turmaId        String
  disciplinaId   String
  professorId    String
  data           DateTime
  horarioAulaId  String?
  observacao     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  periodo        String?
  presenca_aluno PresencaAluno[]
  disciplinas    disciplinas      @relation(fields: [disciplinaId], references: [id])
  horarios_aula  horarios_aula?   @relation(fields: [horarioAulaId], references: [id])
  professores    professores      @relation(fields: [professorId], references: [id])
  turmas         turmas           @relation(fields: [turmaId], references: [id])
}

model turmas {
  id                  String                @id
  nome                String
  ano                 Int
  periodo             String
  professorId         String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  anoLetivo           Int                   @default(2025)
  alunos              alunos[]
  disciplinas_turmas  disciplinas_turmas[]
  frequencias         frequencias[]
  grade_horaria       grade_horaria?
  matriculas          matriculas[]
  registro_frequencia registro_frequencia[]
  professores         professores?          @relation(fields: [professorId], references: [id])
  disciplinas         disciplinas[]         @relation("DisciplinaToTurma")
}

model usuarios {
  id               String    @id
  nome             String
  email            String    @unique
  senha            String
  tipo             String    @default("USUARIO")
  cargo            String?
  ativo            Boolean   @default(true)
  resetTokenExpira DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
}

enum DiaSemana {
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

enum TipoEvento {
  INICIO_ANO_LETIVO
  FIM_ANO_LETIVO
  DIA_LETIVO
  DIA_NAO_LETIVO
  PARADA_PEDAGOGICA
  RECESSO
  SABADO_LETIVO
  FERIADO
  INICIO_TRIMESTRE
  FIM_TRIMESTRE
  PERIODO_EAC
  OUTRO
}

enum TipoPessoa {
  PROFESSOR
  FUNCIONARIO
  EQUIPE_DIRETIVA
}

enum TipoRegistroPonto {
  ENTRADA
  SAIDA
  INTERVALO_INICIO
  INTERVALO_FIM
}

model registro_ponto {
  id                String             @id @default(uuid())
  pessoaId          String
  tipoPessoa        TipoPessoa
  data              DateTime           @default(now())
  horaRegistro      DateTime
  tipoRegistro      TipoRegistroPonto
  localizacao       String?
  observacao        String?
  aprovado          Boolean            @default(true)
  fotoPath          String?
  attestado         Boolean            @default(false)
  reconhecimentoIA  Boolean            @default(false)
  confianca         Float?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([pessoaId, data])
  @@index([tipoPessoa])
}

model configuracao_jornada {
  id                     String            @id @default(uuid())
  pessoaId               String            @unique
  tipoPessoa             TipoPessoa
  cargaHorariaSemanal    Int               @default(40)
  cargaHorariaDiaria     Int               @default(8)
  horarioEntrada         String?
  horarioSaida           String?
  horarioIntervaloInicio String?
  horarioIntervaloFim    String?
  diasTrabalho           String[]          @default(["SEGUNDA", "TERCA", "QUARTA", "QUINTA", "SEXTA"])
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  @@index([pessoaId])
}

model banco_horas {
  id               String      @id @default(uuid())
  pessoaId         String
  tipoPessoa       TipoPessoa
  mes              Int
  ano              Int
  horasTrabalhadas Float       @default(0)
  horasDevidas     Float       @default(0)
  saldo            Float       @default(0)
  observacao       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([pessoaId, mes, ano])
  @@index([pessoaId])
}

model reconhecimento_facial {
  id            String      @id @default(uuid())
  pessoaId      String      @unique
  tipoPessoa    TipoPessoa
  descritores   String      // JSON array de descritores faciais
  fotos         String[]    // URLs das fotos de cadastro
  cadastradoEm  DateTime    @default(now())
  atualizadoEm  DateTime    @updatedAt
  ativo         Boolean     @default(true)

  @@index([pessoaId])
  @@index([tipoPessoa])
}

// Sistema de Notificações Inteligentes
model configuracao_notificacao {
  id                    String                 @id @default(uuid())
  usuarioId             String                 @unique
  tipoPerfil            TipoPerfilNotificacao  
  whatsappAtivo         Boolean                @default(true)
  smsAtivo              Boolean                @default(false)
  notificarFrequencia   Boolean                @default(true)
  notificarNotas        Boolean                @default(true)
  notificarAlertas      Boolean                @default(true)
  resumoDiario          Boolean                @default(false)
  horarioInicio         String?                @default("08:00")
  horarioFim            String?                @default("20:00")
  frequenciaMensagens   FrequenciaMensagens    @default(TODAS)
  // Filtros específicos (JSON)
  disciplinasIds        String?                // JSON array para professores
  turmasIds             String?                // JSON array para professores
  alunosIds             String?                // JSON array para responsáveis
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  @@index([usuarioId])
  @@index([tipoPerfil])
}

model log_notificacao {
  id                String                 @id @default(uuid())
  destinatarioId    String
  tipoPerfil        TipoPerfilNotificacao
  canal             CanalNotificacao
  tipoEvento        TipoEventoNotificacao
  conteudo          String                 // Conteúdo da mensagem
  metadata          String?                // JSON com dados extras (alunoId, disciplinaId, etc)
  status            StatusNotificacao      @default(PENDENTE)
  tentativas        Int                    @default(0)
  erroMsg           String?
  enviadoEm         DateTime?
  confirmarRecebido Boolean                @default(false)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  @@index([destinatarioId])
  @@index([status])
  @@index([createdAt])
}

model webhook_message {
  id                String   @id @default(uuid())
  origem            String   // whatsapp, telegram, sms
  remetenteId       String   // Número ou ID do remetente
  destinatarioId    String?  // ID do usuário no sistema
  mensagem          String
  metadata          String?  // JSON com dados extras
  processado        Boolean  @default(false)
  respostaIA        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([remetenteId])
  @@index([processado])
  @@index([createdAt])
}

enum TipoPerfilNotificacao {
  GESTAO
  PROFESSOR
  RESPONSAVEL
}

enum FrequenciaMensagens {
  TODAS           // Cada evento em tempo real
  ALERTAS         // Apenas alertas importantes
  RESUMO          // Resumo diário
}

enum CanalNotificacao {
  WHATSAPP
  SMS
  TELEGRAM
  EMAIL
}

enum TipoEventoNotificacao {
  NOTA_LANCADA
  FREQUENCIA_FALTA
  FREQUENCIA_PRESENCA
  ALERTA_MEDIA_BAIXA
  ALERTA_FREQUENCIA_BAIXA
  RESUMO_DIARIO
  MENSAGEM_IA
}

enum StatusNotificacao {
  PENDENTE
  ENVIADO
  FALHA
  ENTREGUE
}
